import React, { useState, useEffect, useRef } from 'react';
import { initializeApp, getApps, getApp } from 'firebase/app';
import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from 'firebase/auth';
import { getFirestore, collection, doc, setDoc, onSnapshot, addDoc, deleteDoc, query, orderBy } from 'firebase/firestore';
import { 
  Dices, 
  User, 
  Shield, 
  Wand2, 
  Download, 
  AlertCircle,
  Loader2,
  Save, 
  History, 
  Trash2,
  Zap, 
  Flame,
  Check,
  BookOpen,
  Sword,
  Sparkles,
  ChevronRight, 
  FileText,
  RefreshCw,
  ImageDown,
  ChevronLeft,
  Upload,
  FileJson,
  Lock,
  Coins,
  Package,
  Star,
  Settings2,
  Edit2,
  XCircle,
  RotateCcw,
  Camera,
  Image as ImageIcon
} from 'lucide-react';

/**
 * SLAGHEAP - v2.0.4
 * Milestone: Restored Stat generation, Proficiency calculations, and Citation formatting.
 * Features: Thematic syllabic naming, Art Weaver reference uploads, Archive tools.
 */

// --- Configuration ---
const firebaseConfig = typeof __firebase_config !== 'undefined' 
  ? JSON.parse(__firebase_config) 
  : {
      apiKey: "",
      authDomain: "slagheap-7f791.firebaseapp.com",
      projectId: "slagheap-7f791",
      storageBucket: "slagheap-7f791.firebasestorage.app",
      messagingSenderId: "985062474894",
      appId: "slagheap-gen-v1"
    };

const apiKey = ""; 
const textModel = "gemini-2.5-flash-preview-09-2025";
const imageModel = "imagen-4.0-generate-001";

// Initialize Firebase
const fApp = !getApps().length ? initializeApp(firebaseConfig) : getApp();
const fAuth = getAuth(fApp);
const fDb = getFirestore(fApp);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'slag-heap-gen';

// --- Constants & Data ---
const SETTINGS = ["Faerun", "Sword Coast", "Eberron", "Spelljammer", "Wildemount", "Planescape", "Dragonlance", "Strixhaven", "Other"];
const ART_STYLES = ["Classic D&D", "Realistic", "Water Color", "Anime", "Ink Drawing", "Pencil Sketch Line Art", "Custom"];
const STAT_KEYS = ["str", "dex", "con", "int", "wis", "cha"];
const FEAT_LEVELS = [1, 4, 8, 12, 16, 19];

const SPECIES_CATEGORIES = {
  "Common": ["Human", "Elf", "Dwarf", "Halfling", "Gnome", "Dragonborn", "Tiefling", "Orc", "Goliath"],
  "Eberron": ["Warforged", "Shifter", "Kalashtar", "Changeling"],
  "Wildemount": ["Pallid Elf", "Lotusden Halfling", "Ravenite Dragonborn", "Dragonblood Dragonborn"],
  "Faerun/Regional": ["Aasimar", "Genasi", "Firbolg", "Kenku", "Tabaxi", "Lizardfolk", "Triton", "Bugbear", "Goblin", "Hobgoblin", "Kobold", "Yuan-ti"],
  "Feywild": ["Owlin", "Harengon", "Satyr", "Fairy", "Leonin"],
  "Spelljammer": ["Giff", "Astral Elf", "Autognome", "Hadozee", "Plasmoid", "Thri-kreen"],
  "Other": ["Custom"]
};

const ALL_SPECIES = Object.values(SPECIES_CATEGORIES).flat();
const GENDERS = ["Male", "Female", "Non-binary", "Other", "Custom"];

const BACKGROUND_CATEGORIES = {
  "PHB (2024)": ["Acolyte", "Charlatan", "Criminal", "Entertainer", "Farmer", "Guard", "Guide", "Hermit", "Merchant", "Noble", "Outlander", "Sage", "Sailor", "Soldier", "Wayfarer"],
  "Sword Coast": ["City Watch", "Clan Crafter", "Cloistered Scholar", "Courtier", "Far Traveler", "Inheritor", "Knight of the Order", "Mercenary Veteran", "Urban Bounty Hunter", "Uthgardt Tribe Member", "Waterdhavian Noble"],
  "Eberron": ["Agent of Cannith", "Agent of Deneith", "Agent of Ghallanda", "Agent of Jorasco", "Agent of Kundarak", "Agent of Lyrandar", "Agent of Medani", "Agent of Orien", "Agent of Phiarlan", "Agent of Sivis", "Agent of Tharashk", "Agent of Thuranni", "Agent of Vadalis"],
  "Faerun": ["Harper Agent", "Order of the Gauntlet", "Emerald Enclave", "Lords' Alliance", "Zhentarim Agent", "Smuggler", "Shipwright", "Fisher", "Marine"],
  "Astral/Planar": ["Astral Drifter", "Wildspacer", "Gate Warden", "Planar Philosopher"],
  "Epic/Specific": ["Knight of Solamnia", "Mage of High Sorcery", "Giant Foundling", "Rune Carver", "Silverquill Student", "Lorehold Student", "Prismari Student", "Quandrix Student", "Witherbloom Student"]
};

const BACKGROUND_DATA = {
  "Acolyte": { skills: ["Insight", "Religion"] }, "Charlatan": { skills: ["Deception", "Sleight of Hand"] },
  "Criminal": { skills: ["Deception", "Stealth"] }, "Entertainer": { skills: ["Acrobatics", "Performance"] },
  "Farmer": { skills: ["Animal Handling", "Nature"] }, "Guard": { skills: ["Athletics", "Perception"] },
  "Guide": { skills: ["Stealth", "Survival"] }, "Hermit": { skills: ["Medicine", "Religion"] },
  "Merchant": { skills: ["Animal Handling", "Persuasion"] }, "Noble": { skills: ["History", "Persuasion"] },
  "Outlander": { skills: ["Athletics", "Survival"] }, "Sage": { skills: ["Arcana", "History"] },
  "Sailor": { skills: ["Athletics", "Perception"] }, "Soldier": { skills: ["Athletics", "Intimidation"] },
  "Wayfarer": { skills: ["Insight", "Stealth"] },
  "City Watch": { skills: ["Athletics", "Insight"] }, "Clan Crafter": { skills: ["History", "Insight"] },
  "Cloistered Scholar": { skills: ["History", "Arcana"] }, "Courtier": { skills: ["Insight", "Persuasion"] },
  "Far Traveler": { skills: ["Insight", "Perception"] }, "Inheritor": { skills: ["Survival", "Arcana"] },
  "Knight of the Order": { skills: ["Persuasion", "Religion"] }, "Mercenary Veteran": { skills: ["Athletics", "Persuasion"] },
  "Urban Bounty Hunter": { skills: ["Deception", "Stealth"] }, "Uthgardt Tribe Member": { skills: ["Athletics", "Survival"] },
  "Waterdhavian Noble": { skills: ["History", "Persuasion"] },
  "House Agent": { skills: ["Investigation", "Persuasion"] }, "Faction Agent": { skills: ["Insight", "Perception"] },
  "Smuggler": { skills: ["Deception", "Stealth"] }, "Shipwright": { skills: ["History", "Perception"] },
  "Fisher": { skills: ["History", "Survival"] }, "Marine": { skills: ["Athletics", "Survival"] },
  "Astral Drifter": { skills: ["Insight", "Religion"] }, "Wildspacer": { skills: ["Athletics", "Survival"] },
  "Gate Warden": { skills: ["Persuasion", "Survival"] }, "Planar Philosopher": { skills: ["Arcana", "Persuasion"] },
  "Knight of Solamnia": { skills: ["Athletics", "Survival"] }, "Mage of High Sorcery": { skills: ["Arcana", "History"] },
  "Giant Foundling": { skills: ["Intimidation", "Survival"] }, "Rune Carver": { skills: ["History", "Perception"] },
  "Silverquill Student": { skills: ["Deception", "Intimidation"] }, "Lorehold Student": { skills: ["History", "Religion"] },
  "Prismari Student": { skills: ["Acrobatics", "Performance"] }, "Quandrix Student": { skills: ["Arcana", "Nature"] },
  "Witherbloom Student": { skills: ["Animal Handling", "Nature"] }
};

const CLASS_DATA = {
  "Artificer": { saves: ["con", "int"], skillCount: 2, skills: ["Arcana", "History", "Investigation", "Medicine", "Nature", "Perception", "Sleight of Hand"] },
  "Barbarian": { saves: ["str", "con"], skillCount: 2, skills: ["Animal Handling", "Athletics", "Intimidation", "Nature", "Perception", "Survival"] },
  "Bard": { saves: ["dex", "cha"], skillCount: 3, skills: ["Acrobatics", "Animal Handling", "Arcana", "Athletics", "Deception", "History", "Insight", "Intimidation", "Investigation", "Medicine", "Nature", "Perception", "Performance", "Persuasion", "Religion", "Sleight of Hand", "Stealth", "Survival"] },
  "Cleric": { saves: ["wis", "cha"], skillCount: 2, skills: ["History", "Insight", "Medicine", "Persuasion", "Religion"] },
  "Druid": { saves: ["int", "wis"], skillCount: 2, skills: ["Arcana", "Animal Handling", "Insight", "Medicine", "Nature", "Perception", "Religion", "Survival"] },
  "Fighter": { saves: ["str", "con"], skillCount: 2, skills: ["Acrobatics", "Animal Handling", "Athletics", "History", "Insight", "Intimidation", "Perception", "Survival"] },
  "Monk": { saves: ["str", "dex"], skillCount: 2, skills: ["Acrobatics", "Athletics", "History", "Insight", "Religion", "Stealth"] },
  "Paladin": { saves: ["wis", "cha"], skillCount: 2, skills: ["Athletics", "Insight", "Intimidation", "Medicine", "Persuasion", "Religion"] },
  "Ranger": { saves: ["str", "dex"], skillCount: 3, skills: ["Animal Handling", "Athletics", "Insight", "Investigation", "Nature", "Perception", "Stealth", "Survival"] },
  "Rogue": { saves: ["dex", "int"], skillCount: 4, skills: ["Acrobatics", "Animal Handling", "Athletics", "Deception", "Insight", "Intimidation", "Investigation", "Perception", "Performance", "Persuasion", "Sleight of Hand", "Stealth"] },
  "Sorcerer": { saves: ["con", "cha"], skillCount: 2, skills: ["Arcana", "Deception", "Insight", "Intimidation", "Persuasion", "Religion"] },
  "Warlock": { saves: ["wis", "cha"], skillCount: 2, skills: ["Arcana", "Deception", "History", "Intimidation", "Investigation", "Nature", "Religion"] },
  "Wizard": { saves: ["int", "wis"], skillCount: 2, skills: ["Arcana", "History", "Insight", "Investigation", "Medicine", "Religion"] }
};

const ABILITY_SKILLS = {
  str: ["Athletics"], dex: ["Acrobatics", "Sleight of Hand", "Stealth"], con: [],
  int: ["Arcana", "History", "Investigation", "Nature", "Religion"],
  wis: ["Animal Handling", "Insight", "Medicine", "Perception", "Survival"],
  cha: ["Deception", "Intimidation", "Performance", "Persuasion"]
};

const ALL_SKILLS = Object.entries(ABILITY_SKILLS).flatMap(([ability, skills]) => skills.map(name => ({ name, ability })));

// --- Helper Functions ---
const getModifier = (score) => Math.floor((parseInt(score || 10) - 10) / 2);
const formatBonus = (val) => (val === undefined || isNaN(val)) ? "-" : `${val >= 0 ? '+' : ''}${val}`;
const getProficiencyBonus = (level) => Math.floor((parseInt(level) - 1) / 4) + 2;

// --- API Logic ---
async function callGemini(payload, systemInstruction, structured = false, imageBase64 = null) {
  const maxRetries = 5;
  for (let i = 0; i <= maxRetries; i++) {
    try {
      const parts = [{ text: payload }];
      if (imageBase64) { parts.push({ inlineData: { mimeType: "image/png", data: imageBase64.split(',')[1] } }); }
      const body = {
        contents: [{ parts }],
        systemInstruction: { parts: [{ text: systemInstruction }] }
      };
      if (structured) body.generationConfig = { responseMimeType: "application/json" };
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${textModel}:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });
      if (!response.ok) throw new Error('Gemini API Error');
      const data = await response.json();
      return data.candidates?.[0]?.content?.parts?.[0]?.text;
    } catch (err) {
      if (i === maxRetries) throw err;
      await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
    }
  }
}

async function generateCharacterImage(promptText) {
  const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${imageModel}:predict?key=${apiKey}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      instances: { prompt: promptText },
      parameters: { sampleCount: 1 }
    })
  });
  const result = await response.json();
  if (result.predictions?.[0]) { return `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`; }
  throw new Error("Imagen failure");
}

const compressImage = async (base64Str, maxWidth = 512, quality = 0.7) => {
  return new Promise((resolve) => {
    const img = new Image();
    img.src = base64Str;
    img.onload = () => {
      const canvas = document.createElement('canvas');
      let width = img.width, height = img.height;
      if (width > maxWidth) {
        height = Math.round((height * maxWidth) / width);
        width = maxWidth;
      }
      canvas.width = width; canvas.height = height;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, width, height);
      resolve(canvas.toDataURL('image/jpeg', quality));
    };
    img.onerror = () => resolve(base64Str);
  });
};

// --- Reusable UI Component ---
const ScreenWrapper = ({ children, title, subtitle }) => (
  <div className="max-w-2xl mx-auto py-12 px-6 animate-in fade-in slide-in-from-bottom-4 duration-500 text-zinc-100 font-black uppercase italic">
    <div className="text-center mb-10">
      <h2 className="text-4xl text-orange-500 uppercase tracking-tighter">{title}</h2>
      {subtitle && <p className="text-zinc-500 font-serif normal-case italic">{subtitle}</p>}
    </div>
    {children}
  </div>
);

const App = () => {
  const [user, setUser] = useState(null);
  const [step, setStep] = useState(1);
  const [loading, setLoading] = useState(false);
  const [loadingMessage, setLoadingMessage] = useState("Forging Hero...");
  const [error, setError] = useState(null);
  const [character, setCharacter] = useState(null);
  const [imageChoices, setImageChoices] = useState([]);
  const [selectedImage, setSelectedImage] = useState(null);
  const [uploadedRef, setUploadedRef] = useState(null);
  const [savedCharacters, setSavedCharacters] = useState([]);
  const [view, setView] = useState('welcome');
  const [slagLevel, setSlagLevel] = useState("Random");
  const [slagSetting, setSlagSetting] = useState("Random");
  const [isEditingName, setIsEditingName] = useState(false);
   
  const recordRef = useRef(null);
  const fileInputRef = useRef(null);
  const artUploadRef = useRef(null);

  const [formData, setFormData] = useState({
    level: 1, setting: "Faerun", species: "Human", customSpecies: "", className: "Fighter", background: "Soldier",
    name: "", gender: "Male", customGender: "", statRules: "4d6 drop the lowest", manualStats: { str: 10, dex: 10, con: 10, int: 10, wis: 10, cha: 10 },
    hpRules: "Roll for HP", skillProficiencies: [], keyFeatures: "", artStyle: "Classic D&D", artTweaks: ""
  });

  useEffect(() => {
    const script = document.createElement('script');
    script.src = "https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js";
    script.async = true;
    document.body.appendChild(script);
  }, []);

  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(fAuth, __initial_auth_token);
        } else {
          await signInAnonymously(fAuth);
        }
      } catch (err) { console.error("Auth Error:", err); }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(fAuth, setUser);
    return () => unsubscribe();
  }, []);

  useEffect(() => {
    if (!user) return;
    const q = collection(fDb, 'artifacts', appId, 'users', user.uid, 'characters');
    const unsubscribe = onSnapshot(q, (snapshot) => {
      setSavedCharacters(snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id })));
    }, (err) => console.error("Firestore error:", err));
    return () => unsubscribe();
  }, [user]);

  const updateFormVal = (field, value) => setFormData(prev => ({ ...prev, [field]: value }));
  const updateManualStat = (stat, val) => setFormData(p => ({ ...p, manualStats: { ...p.manualStats, [stat]: parseInt(val) || 10 } }));
  const handleNameChange = (val) => {
    setFormData(prev => ({ ...prev, name: val }));
    if (character) {
      setCharacter(prev => ({
        ...prev,
        coreIdentity: { ...prev.coreIdentity, name: val }
      }));
    }
  };
  const nextStep = () => setStep(s => s + 1);
  const prevStep = () => setStep(s => s - 1);

  const resetForge = () => {
    setCharacter(null); setSelectedImage(null); setUploadedRef(null); setImageChoices([]); setStep(1); setView('generator');
    setFormData({
      level: 1, setting: "Faerun", species: "Human", customSpecies: "", className: "Fighter", background: "Soldier",
      name: "", gender: "Male", customGender: "", statRules: "4d6 drop the lowest", manualStats: { str: 10, dex: 10, con: 10, int: 10, wis: 10, cha: 10 },
      hpRules: "Roll for HP", skillProficiencies: [], keyFeatures: "", artStyle: "Classic D&D", artTweaks: ""
    });
  };

  const handleArtUpload = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = async (event) => {
      const compressed = await compressImage(event.target.result, 1024, 0.8);
      setUploadedRef(compressed);
    };
    reader.readAsDataURL(file);
  };

  const toggleSkillChoice = (skillName) => {
    const bgSkills = BACKGROUND_DATA[formData.background]?.skills || [];
    if (bgSkills.includes(skillName)) return;
    const limit = CLASS_DATA[formData.className]?.skillCount || 2;
    setFormData(prev => {
      const isProf = prev.skillProficiencies.includes(skillName);
      if (isProf) return { ...prev, skillProficiencies: prev.skillProficiencies.filter(s => s !== skillName) };
      if (prev.skillProficiencies.length < limit) return { ...prev, skillProficiencies: [...prev.skillProficiencies, skillName] };
      return prev;
    });
  };

  const generateCharacterData = async (overrideData = null) => {
    setLoadingMessage("Forging Hero...");
    setLoading(true); setError(null);
    const activeData = overrideData || formData;
    try {
      const sysPrompt = `You are a D&D 2024 Foundry Master. Generate character JSON.
      STRICT CONSTRAINTS:
      - NAME: If coreIdentity.name is empty, generate a random unique name with syllables/keywords typical for ${activeData.species} and ${activeData.gender}.
      - ABILITY SCORES: You MUST generate scores defaulting to 4d6-drop-lowest logic.
      - PROFICIENCIES: You MUST provide a "skillProficiencies" array based on 2024 Class and Background rules.
      - NARRATIVE: 'backgroundStory' max 4 paragraphs, 'description' max 150 words.
      - MILESTONES: Populate Level 1 Origin Feat and milestones [4, 8, 12, 16, 19] as reached.
      - SUMMARIES: EVERY feature, feat, trait, item, and spell MUST have a descriptive "summary".
      - CITATIONS: EVERY reference MUST adhere to the (Abbrv XX) book and page number format (e.g. (PHB 123)).
      - COMBAT/GEAR: Generate 'mainAttacks' and 'equipment' arrays with summaries.
      - SPELLCASTING: Calculate correct "spellDC" (8 + Prof + Mod) and "spellAttack" (Prof + Mod). Populate "spellsByLevel" with string keys ("0", "1", etc).
      Structure: { 
        "coreIdentity": { "name": "...", "species": "...", "className": "...", "level": ${activeData.level}, "background": "...", "alignment": "...", "gender": "..." }, 
        "abilityScores": { "str": 10, "dex": 10, "con": 10, "int": 10, "wis": 10, "cha": 10 }, 
        "vitals": { "hp": 10, "ac": 15, "speed": "30ft", "initiative": 2, "bonusActions": [], "reactions": [] }, 
        "skillProficiencies": ["Athletics"], "savingThrowProficiencies": [], 
        "mainAttacks": [ { "name": "...", "bonus": 5, "damage": "...", "type": "..." } ], 
        "classFeatures": [ { "name": "...", "summary": "...", "source": "(PHB 123)" } ], 
        "subclassFeatures": [], "speciesFeatures": [], "feats": [],
        "equipment": [ { "name": "...", "summary": "...", "source": "(PHB 210)" } ], "attunedItems": [],
        "currency": { "gp": 10 }, 
        "spellcasting": { "isCaster": true, "spellAttack": 5, "spellDC": 13, "slots": { "1": 4 }, "spellsByLevel": { "0": [], "1": [] } }, 
        "description": "...", "backgroundStory": "..." 
      }`;
      const queryText = `Forge Lvl ${activeData.level} ${activeData.species} ${activeData.className}. Gender: ${activeData.gender}. World: ${activeData.setting}. Background: ${activeData.background}. User Detail: ${activeData.keyFeatures}`;
      const res = await callGemini(queryText, sysPrompt, true);
      const parsed = JSON.parse(res.replace(/```json|```/g, '').trim());
      setCharacter(parsed); setStep(10);
    } catch (err) { setError(`Foundry Failure: ${err.message}`); }
    finally { setLoading(false); }
  };

  const reRollName = async () => {
    if (!character) return;
    setLoadingMessage("Consulting Lineage..."); setLoading(true);
    try {
      const prompt = `Generate a unique thematic D&D name for a ${character.coreIdentity?.gender} ${character.coreIdentity?.species} ${character.coreIdentity?.className}. Synergy with ${formData.setting}. Syllabic accuracy required. Return ONLY name.`;
      const res = await callGemini(prompt, "Naming Forge.");
      handleNameChange(res.trim());
    } catch (err) { console.error(err); } finally { setLoading(false); }
  };

  const reRollStory = async () => {
    if (!character) return;
    setLoadingMessage("Consulting the Weave..."); setLoading(true);
    try {
      const prompt = `Generate a 4-paragraph story for ${character.coreIdentity?.name}, Lvl ${character.coreIdentity?.level} ${character.coreIdentity?.species} ${character.coreIdentity?.className}. World: ${formData.setting}. Use citation format (Abbrv XX) for world references.`;
      const res = await callGemini(prompt, "Narrative Weaver.");
      setCharacter({ ...character, backgroundStory: res.trim() });
    } catch (err) { console.error(err); } finally { setLoading(false); }
  };

  const reRollAppearance = async () => {
    if (!character) return;
    setLoadingMessage("Visualizing Hero..."); setLoading(true);
    try {
      const prompt = `Describe the appearance of ${character.coreIdentity?.name}, a ${character.coreIdentity?.species} ${character.coreIdentity?.className}. Max 150 words. Focus on gear and distinctive traits.`;
      const res = await callGemini(prompt, "Visual Weaver.");
      setCharacter({ ...character, description: res.trim() });
    } catch (err) { console.error(err); } finally { setLoading(false); }
  };

  const generateArt = async () => {
    if (!character) return;
    setLoadingMessage("Casting Vision..."); setLoading(true); setError(null);
    try {
      // Enhanced Contextual Data Extraction
      const identity = character.coreIdentity || {};
      const contextData = {
        name: identity.name || "Unknown",
        species: identity.species || formData.species,
        gender: identity.gender || formData.gender,
        class: identity.className || formData.className,
        background: identity.background || formData.background,
        setting: formData.setting,
        appearance: character.description || "No description available.",
        backstory: character.backgroundStory || "No backstory available.",
        style: formData.artStyle,
        tweaks: formData.artTweaks
      };

      const systemPrompt = `You are an expert Fantasy Art Director for D&D. 
      Generate 3 distinct, highly detailed image generation prompts based on this character profile.
      
      STRICT REQUIREMENTS:
      1. SUBJECT: ${contextData.gender} ${contextData.species} ${contextData.class}.
      2. SETTING: ${contextData.setting}. Ensure background elements reflect this world.
      3. APPEARANCE: Use specific details from: "${contextData.appearance}".
      4. STYLE: ${contextData.style}.
      5. DETAILS: Include specific class equipment, background hints (${contextData.background}), and atmospheric lighting.
      6. OUTPUT: Return ONLY a valid JSON array of 3 strings.
      
      Profile Context:
      ${JSON.stringify(contextData)}
      `;

      let prompts;
      if (uploadedRef) {
        const res = await callGemini(`Analyze the reference image and the character profile. Generate 3 prompts blending the reference composition with the character details. Output JSON array.`, systemPrompt, true, uploadedRef);
        prompts = JSON.parse(res.replace(/```json|```/g, '').trim());
      } else {
        const res = await callGemini(`Generate 3 detailed prompts for this character. Output JSON array.`, systemPrompt, true);
        prompts = JSON.parse(res.replace(/```json|```/g, '').trim());
      }
      
      const imgs = await Promise.all(prompts.slice(0, 3).map(p => generateCharacterImage(p)));
      setImageChoices(imgs); setStep(9);
    } catch (err) { setError(`Vision failed: ${err.message}`); } finally { setLoading(false); }
  };

  const handleCheckTheSlag = () => {
    setCharacter(null); setSelectedImage(null); setUploadedRef(null);
    const finalLevel = slagLevel === "Random" ? Math.floor(Math.random() * 20) + 1 : parseInt(slagLevel);
    const finalSetting = slagSetting === "Random" ? SETTINGS[Math.floor(Math.random() * (SETTINGS.length - 1))] : slagSetting;
    let availableSpecies = [...SPECIES_CATEGORIES["Common"]];
    if (finalSetting === "Eberron") availableSpecies.push(...SPECIES_CATEGORIES["Eberron"]);
    else if (finalSetting === "Wildemount") availableSpecies.push(...SPECIES_CATEGORIES["Wildemount"]);
    else if (finalSetting === "Faerun" || finalSetting === "Sword Coast") availableSpecies.push(...SPECIES_CATEGORIES["Faerun/Regional"]);
    else if (finalSetting === "Spelljammer") availableSpecies.push(...SPECIES_CATEGORIES["Spelljammer"]);
    else { availableSpecies = ALL_SPECIES.filter(s => s !== "Custom"); }
    let availableBackgrounds = Object.values(BACKGROUND_CATEGORIES).flat();
    const slagData = { ...formData, level: finalLevel, setting: finalSetting, species: availableSpecies[Math.floor(Math.random() * availableSpecies.length)], background: availableBackgrounds[Math.floor(Math.random() * availableBackgrounds.length)], gender: GENDERS[Math.floor(Math.random() * (GENDERS.length - 1))], className: Object.keys(CLASS_DATA)[Math.floor(Math.random() * Object.keys(CLASS_DATA).length)], keyFeatures: "Slag generation." };
    setFormData(slagData); setView('generator'); generateCharacterData(slagData);
  };

  const saveToLibrary = async () => {
    if (!user || !character) return;
    setLoadingMessage("Archiving Hero..."); setLoading(true);
    try {
      const col = collection(fDb, 'artifacts', appId, 'users', user.uid, 'characters');
      let portrait = selectedImage;
      if (portrait && portrait.length > 500000) portrait = await compressImage(portrait);
      await addDoc(col, { ...character, portrait, createdAt: new Date().toISOString() });
      setView('library');
    } catch (err) { setError("Archive failed."); } finally { setLoading(false); }
  };

  const deleteChar = async (id) => {
    if (!user) return;
    try { await deleteDoc(doc(fDb, 'artifacts', appId, 'users', user.uid, 'characters', id)); } catch (err) { console.error(err); }
  };

  const exportPDF = () => {
    if (!recordRef.current) return;
    const opt = { margin: 0, filename: `${character.coreIdentity?.name || 'hero'}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
    // @ts-ignore
    window.html2pdf().set(opt).from(recordRef.current).save();
  };

  return (
    <div className="min-h-screen bg-zinc-950 text-zinc-100 font-sans selection:bg-orange-500/30">
      <header className="py-8 text-center no-print">
        <div className="inline-block px-12 py-4 border-4 border-zinc-900 bg-zinc-900 shadow-2xl rounded-sm">
            <h1 className="text-6xl md:text-7xl font-black tracking-tighter uppercase italic text-orange-500 drop-shadow-[0_0_15px_rgba(255,165,0,0.5)]">SlagHeap</h1>
            <p className="text-xs font-bold tracking-[0.3em] uppercase mt-2 text-zinc-500 font-black">Salvaging legends from the foundry floor</p>
        </div>
      </header>

      <nav className="flex justify-center gap-4 mb-12 no-print text-white font-black italic uppercase">
        {['welcome', 'generator', 'library'].map(id => (
          <button key={id} onClick={() => setView(id)} className={`flex items-center gap-2 px-6 py-2 rounded-full font-black uppercase transition-all border-2 ${view === id ? 'bg-orange-600 border-orange-600 text-white shadow-lg' : 'bg-zinc-900 border-zinc-800 text-zinc-500 hover:text-zinc-300'}`}>
            {id === 'welcome' ? <Flame size={16} /> : id === 'generator' ? <Dices size={16} /> : <History size={16} />} 
            {id === 'library' ? 'Archives' : id.charAt(0).toUpperCase() + id.slice(1)}
          </button>
        ))}
      </nav>

      <main className="container mx-auto pb-24 px-4">
        {error && <div className="max-w-md mx-auto mb-8 p-4 bg-red-900/20 border border-red-900 rounded-xl text-red-400 font-black uppercase italic"><AlertCircle size={20} /> {error}</div>}
        
        {loading && view !== 'welcome' ? (
          <div className="flex flex-col items-center justify-center py-20 text-white font-black italic uppercase text-center animate-pulse">
            <Loader2 size={64} className="text-orange-500 animate-spin mb-4 mx-auto" />
            <h3 className="text-2xl tracking-widest">{loadingMessage}</h3>
          </div>
        ) : (
          <>
            {view === 'welcome' && (
              <div className="max-w-2xl mx-auto space-y-6 py-12 text-center animate-in fade-in slide-in-from-bottom-4 duration-500 text-white font-black italic uppercase">
                <div className="mb-10 text-white font-black uppercase italic"><h2 className="text-4xl tracking-tighter">the foundry is hot</h2><p className="text-zinc-500 font-serif normal-case italic text-lg">Ready the iron.</p></div>
                <button onClick={resetForge} className="w-full group relative overflow-hidden p-8 bg-zinc-900 border-2 border-zinc-800 hover:border-blue-500 rounded-3xl transition-all shadow-2xl flex flex-col items-center justify-center">
                  <div className="flex items-center gap-4 mb-2 font-black italic uppercase"><Sword size={48} className="text-zinc-400 group-hover:text-blue-400" /><h3 className="text-4xl tracking-tight italic">Fresh Ore</h3></div>
                </button>
                <div className="relative group overflow-hidden bg-gradient-to-br from-orange-600 via-orange-700 to-red-900 border-2 border-orange-500 rounded-3xl transition-all shadow-2xl flex flex-col">
                    <div className="flex items-stretch">
                      <div className="w-28 flex flex-col items-center justify-center bg-black/20 hover:bg-black/40 cursor-pointer border-r border-white/10">
                        <label className="text-[9px] text-orange-200 uppercase tracking-widest mb-1 opacity-60 font-black italic">World</label>
                        <select value={slagSetting} onChange={(e) => setSlagSetting(e.target.value)} className="bg-transparent text-white font-black text-xs outline-none cursor-pointer appearance-none px-2 text-center uppercase tracking-tighter italic">
                          <option value="Random" className="bg-zinc-900">RND</option>
                          {SETTINGS.map(s => (<option key={s} value={s} className="bg-zinc-900 italic">{s.slice(0, 10)}</option>))}
                        </select>
                      </div>
                      <button onClick={handleCheckTheSlag} className="flex-1 p-8 flex flex-col items-center justify-center gap-1 hover:bg-black/10 transition-all text-center italic">
                        <div className="flex items-center gap-4 mb-2"><Zap size={48} fill="currentColor" /><h3 className="text-4xl font-black uppercase tracking-tight italic">Check the Slag</h3></div>
                      </button>
                      <div className="w-24 flex flex-col items-center justify-center bg-black/20 hover:bg-black/40 cursor-pointer border-l border-white/10 italic">
                        <label className="text-[9px] font-black text-orange-200 uppercase tracking-widest mb-1 opacity-60 font-black italic">Level</label>
                        <select value={slagLevel} onChange={(e) => setSlagLevel(e.target.value)} className="bg-transparent text-white font-black text-xl outline-none cursor-pointer appearance-none px-2 text-center italic font-black">
                          <option value="Random" className="bg-zinc-900 text-sm italic">RND</option>
                          {Array.from({ length: 20 }).map((_, i) => (<option key={i+1} value={i+1} className="bg-zinc-900 italic font-black">{i+1}</option>))}
                        </select>
                      </div>
                    </div>
                </div>
              </div>
            )}

            {view === 'library' && (
              <ScreenWrapper title="Archives">
                <div className="flex gap-4 mb-8 justify-center text-white font-black uppercase italic">
                    <button onClick={() => { const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(savedCharacters)); const dlAnchor = document.createElement('a'); dlAnchor.setAttribute("href", dataStr); dlAnchor.setAttribute("download", `Archive_Export.json`); dlAnchor.click(); }} className="flex items-center gap-2 px-4 py-2 bg-zinc-900 border border-zinc-800 rounded-xl hover:border-orange-500 transition-all text-zinc-400 text-xs"><Download size={16} /> Export JSON</button>
                    <button onClick={() => fileInputRef.current?.click()} className="flex items-center gap-2 px-4 py-2 bg-zinc-900 border border-zinc-800 rounded-xl hover:border-orange-500 transition-all text-zinc-400 text-xs"><Upload size={16} /> Import JSON</button>
                    <input type="file" ref={fileInputRef} onChange={(e) => { 
                      const file = e.target.files[0]; if (!file || !user) return; const reader = new FileReader(); 
                      reader.onload = async (event) => { 
                        try { 
                          const imported = JSON.parse(event.target.result); if (!Array.isArray(imported)) return; 
                          setLoadingMessage("Checking Old Records..."); setLoading(true); 
                          const col = collection(fDb, 'artifacts', appId, 'users', user.uid, 'characters'); 
                          for (const char of imported) { const { id, ...clean } = char; await addDoc(col, clean); } 
                          setLoading(false); 
                        } catch (err) { setError("Import failed."); setLoading(false); } 
                      }; 
                      reader.readAsText(file); 
                    }} accept=".json" className="hidden" />
                </div>
                <div className="grid gap-4">
                  {savedCharacters.map(char => (
                    <div key={char.id} className="bg-zinc-900 p-6 rounded-2xl border border-zinc-800 flex items-center justify-between hover:border-orange-500 transition-all group text-white font-black uppercase italic">
                      <div className="flex items-center gap-6">
                        {char.portrait ? <img src={char.portrait} className="w-16 h-16 rounded-xl object-cover border border-zinc-800" alt="" /> : <div className="w-16 h-16 bg-zinc-800 rounded-xl flex items-center justify-center text-zinc-600">N/A</div>}
                        <div><h3 className="text-xl text-zinc-100 italic">{char.coreIdentity?.name || "Unnamed"}</h3><p className="text-orange-500 text-sm tracking-widest">Lvl {char.coreIdentity?.level} {char.coreIdentity?.species} {char.coreIdentity?.className}</p></div>
                      </div>
                      <div className="flex gap-2 text-white"><button onClick={() => { setCharacter(char); setSelectedImage(char.portrait); setStep(10); setView('generator'); }} className="p-2 bg-zinc-800 hover:bg-orange-600 rounded-lg transition-colors"><ChevronRight size={18} /></button><button onClick={() => deleteChar(char.id)} className="p-2 bg-zinc-800 hover:bg-red-600 rounded-lg transition-colors text-white"><Trash2 size={18} /></button></div>
                    </div>
                  ))}
                </div>
              </ScreenWrapper>
            )}

            {view === 'generator' && (
              <div className="max-w-4xl mx-auto">
                {step === 1 && (
                  <ScreenWrapper title="Power" subtitle="Set level">
                    <div className="relative w-full mb-12 mt-8 px-2"><input type="range" min="1" max="20" value={formData.level} onChange={e => updateFormVal('level', parseInt(e.target.value))} className="w-full accent-orange-500 h-2 bg-zinc-800 rounded-lg" /></div>
                    <div className="text-center text-9xl font-black mb-8 italic drop-shadow-2xl text-white">Lvl {formData.level}</div>
                    <button onClick={nextStep} className="w-full bg-orange-600 py-4 rounded-2xl font-black uppercase text-xl hover:bg-orange-700 transition-all italic text-white">Continue <ChevronRight className="inline" /></button>
                  </ScreenWrapper>
                )}
                {step === 2 && (
                    <ScreenWrapper title="World" subtitle="Select Setting">
                    <div className="grid grid-cols-2 md:grid-cols-3 gap-6 text-white font-black italic uppercase">
                      {SETTINGS.map(s => (
                        <button key={s} onClick={() => { updateFormVal('setting', s); nextStep(); }} className="aspect-square flex items-center justify-center p-8 rounded-3xl border-4 border-zinc-800 hover:border-orange-500 hover:bg-orange-500/5 transition-all text-xl italic tracking-tighter text-center">{s}</button>
                      ))}
                    </div>
                  </ScreenWrapper>
                )}
                {step === 3 && (
                  <ScreenWrapper title="Identity" subtitle="Define the Being">
                    <div className="space-y-4 text-white font-black italic uppercase text-left">
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="space-y-1"><label className="text-[10px] text-zinc-500 ml-1 italic uppercase">Name</label><input placeholder="..." value={formData.name} onChange={e => updateFormVal('name', e.target.value)} className="w-full bg-zinc-900 border-2 border-zinc-800 p-4 rounded-xl focus:border-orange-500 outline-none text-white font-black uppercase italic" /></div>
                        <div className="space-y-1"><label className="text-[10px] text-zinc-500 ml-1 italic uppercase">Gender</label><select value={formData.gender} onChange={e => updateFormVal('gender', e.target.value)} className="w-full bg-zinc-900 border-2 border-zinc-800 p-4 rounded-xl text-white font-black uppercase italic">{GENDERS.map(g => <option key={g} value={g}>{g}</option>)}</select></div>
                      </div>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="space-y-1"><label className="text-[10px] text-zinc-500 ml-1 italic uppercase">Species</label><select value={formData.species} onChange={e => updateFormVal('species', e.target.value)} className="w-full bg-zinc-900 border-2 border-zinc-800 p-4 rounded-xl text-white font-black uppercase italic">{Object.entries(SPECIES_CATEGORIES).map(([cat, list]) => (<optgroup key={cat} label={`${cat} Races`}>{list.map(s => <option key={s} value={s}>{s}</option>)}</optgroup>))}</select></div>
                        <div className="space-y-1"><label className="text-[10px] text-zinc-500 ml-1 italic uppercase">Class</label><select value={formData.className} onChange={e => updateFormVal('className', e.target.value)} className="w-full bg-zinc-900 border-2 border-zinc-800 p-4 rounded-xl text-white font-black uppercase italic">{Object.keys(CLASS_DATA).map(c => <option key={c} value={c}>{c}</option>)}</select></div>
                      </div>
                      <div className="space-y-1"><label className="text-[10px] text-zinc-500 ml-1 italic uppercase">Background</label><select value={formData.background} onChange={e => updateFormVal('background', e.target.value)} className="w-full bg-zinc-900 border-2 border-zinc-800 p-4 rounded-xl text-white font-black uppercase italic">{Object.entries(BACKGROUND_CATEGORIES).map(([cat, list]) => (<optgroup key={cat} label={`${cat} Backgrounds`}>{list.map(b => <option key={b} value={b}>{b}</option>)}</optgroup>))}</select></div>
                      <div className="flex gap-4 pt-4 font-black italic uppercase"><button onClick={prevStep} className="flex-1 bg-zinc-800 py-4 rounded-xl hover:bg-zinc-700 transition-all font-black">Back</button><button onClick={nextStep} className="flex-1 bg-orange-600 py-4 rounded-xl hover:bg-orange-700 transition-all text-xl font-black">Continue</button></div>
                    </div>
                  </ScreenWrapper>
                )}
                {/* Manual Steps 4-7 Preserved */}
                {step === 4 && (
                  <ScreenWrapper title="Abilities" subtitle="Methodology">
                    <div className="space-y-6 text-white font-black italic uppercase">
                      <div className="grid grid-cols-2 gap-4">{["4d6 drop low", "3d6", "Point Buy", "Manual"].map(m => (<button key={m} onClick={() => updateFormVal('statRules', m)} className={`p-4 rounded-xl border-2 transition-all ${formData.statRules === m ? 'border-orange-500 bg-orange-500/10' : 'border-zinc-800 hover:border-zinc-700'}`}>{m}</button>))}</div>
                      {(formData.statRules === "Point Buy" || formData.statRules === "Manual") && (<div className="grid grid-cols-3 gap-4 bg-zinc-900 p-6 rounded-2xl border-2 border-zinc-800">{STAT_KEYS.map(s => (<div key={s} className="space-y-1 text-left"><label className="text-[10px] text-zinc-500 ml-1 uppercase font-black italic">{s}</label><input type="number" value={formData.manualStats[s]} onChange={e => updateManualStat(s, e.target.value)} className="w-full bg-zinc-950 border border-zinc-800 p-2 rounded-lg text-center outline-none focus:border-orange-500 text-white font-black uppercase italic" /></div>))}</div>)}
                      <div className="flex gap-4 pt-4 font-black uppercase italic text-white"><button onClick={prevStep} className="flex-1 bg-zinc-800 py-4 rounded-xl hover:bg-zinc-700 transition-all">Back</button><button onClick={nextStep} className="flex-1 bg-orange-600 py-4 rounded-xl hover:bg-orange-700 transition-all text-xl font-black">Continue</button></div>
                    </div>
                  </ScreenWrapper>
                )}
                {step === 5 && (
                  <ScreenWrapper title="Resilience" subtitle="HP Strategy">
                    <div className="space-y-6 text-center text-white font-black italic uppercase">
                      <div className="grid grid-cols-2 gap-4">{["Roll for HP", "Take Average"].map(m => (<button key={m} onClick={() => updateFormVal('hpRules', m)} className={`p-6 rounded-2xl border-2 transition-all ${formData.hpRules === m ? 'border-orange-500 bg-orange-500/10' : 'border-zinc-800 hover:border-zinc-700'}`}>{m}</button>))}</div>
                      <div className="flex gap-4"><button onClick={prevStep} className="flex-1 bg-zinc-800 py-4 rounded-xl transition-all hover:bg-zinc-700 font-black">Back</button><button onClick={nextStep} className="flex-1 bg-orange-600 py-4 rounded-xl hover:bg-orange-700 transition-all italic text-xl font-black">Continue</button></div>
                    </div>
                  </ScreenWrapper>
                )}
                {step === 6 && (
                  <ScreenWrapper title="Expertise" subtitle={`${formData.className} Skills`}>
                    <div className="space-y-8 text-white font-black italic uppercase text-left">
                        <div className="mb-4 p-4 bg-zinc-900/50 border border-zinc-800 rounded-xl">
                          <label className="text-[10px] text-orange-500 mb-2 block tracking-widest font-black uppercase italic">Background Proficiencies</label>
                          <div className="flex flex-wrap gap-2 text-zinc-900 font-black italic uppercase">{(BACKGROUND_DATA[formData.background]?.skills || []).map(s => (<span key={s} className="px-3 py-1 bg-orange-500/10 border border-orange-500/40 rounded-lg text-[10px] text-orange-200 flex items-center gap-1.5 shadow-sm"><Lock size={10} /> {s}</span>))}</div>
                        </div>
                        <div>
                          <div className="flex justify-between items-center mb-3"><h4>Selection</h4><span className="text-[10px] text-orange-500 px-2 py-0.5 bg-orange-950/20 rounded border border-orange-900/50 italic font-black uppercase">Select {CLASS_DATA[formData.className]?.skillCount}</span></div>
                          <div className="grid grid-cols-2 gap-3 text-zinc-900">
                             {ALL_SKILLS.map(s => {
                               const isClassOption = CLASS_DATA[formData.className]?.skills?.includes(s.name);
                               const bgSkills = BACKGROUND_DATA[formData.background]?.skills || [];
                               const isBgSkill = bgSkills.includes(s.name);
                               const isSelected = formData.skillProficiencies.includes(s.name);
                               if (!isClassOption) return null;
                               return (<button key={s.name} onClick={() => toggleSkillChoice(s.name)} disabled={isBgSkill} className={`p-3 rounded-xl border-2 text-[10px] transition-all flex items-center justify-between shadow-sm font-black italic uppercase ${isBgSkill ? 'border-orange-500/20 bg-zinc-900/40 text-orange-950 cursor-not-allowed opacity-40' : isSelected ? 'border-orange-500 bg-orange-500/10 text-white' : 'border-zinc-800 text-zinc-500 hover:border-zinc-700'}`}><span>{s.name}</span>{isBgSkill ? <Lock size={12} /> : isSelected && <Check size={12} strokeWidth={4}/>}</button>);
                             })}
                          </div>
                        </div>
                        <div className="flex gap-4 pt-4 text-white"><button onClick={prevStep} className="flex-1 bg-zinc-800 py-4 rounded-xl hover:bg-zinc-700 transition-all font-black italic uppercase">Back</button><button onClick={nextStep} className="flex-1 bg-orange-600 py-4 rounded-xl hover:bg-orange-700 transition-all italic text-xl text-white font-black italic uppercase">Continue</button></div>
                    </div>
                  </ScreenWrapper>
                )}
                {step === 7 && (
                  <ScreenWrapper title="Traits" subtitle="Define the Soul">
                    <textarea rows={6} value={formData.keyFeatures} onChange={e => updateFormVal('keyFeatures', e.target.value)} className="w-full bg-zinc-900 border-2 border-zinc-800 p-4 rounded-xl outline-none focus:border-orange-500 text-white resize-none font-black italic uppercase" placeholder="..." />
                    <div className="flex gap-4 mt-4 text-white font-black italic uppercase"><button onClick={prevStep} className="flex-1 bg-zinc-800 py-4 rounded-xl hover:bg-zinc-700 transition-all font-black">Back</button><button onClick={() => generateCharacterData()} className="flex-1 bg-orange-600 py-4 rounded-xl hover:bg-orange-700 transition-all text-xl font-black">Forge Hero</button></div>
                  </ScreenWrapper>
                )}
                {step === 8 && character && (
                  <div className="text-center py-20 animate-in zoom-in-95 duration-700 text-white font-black italic uppercase">
                    <div className="flex items-center justify-center gap-4 mb-2 font-black italic uppercase"><h1 className="text-7xl tracking-tighter drop-shadow-2xl">{character.coreIdentity?.name || "Unnamed"}</h1><button onClick={reRollName} className="p-2 bg-white/10 hover:bg-orange-500 rounded-full transition-colors group text-white"><Sparkles size={24} className="text-zinc-400 group-hover:text-white" /></button></div>
                    <p className="text-2xl text-orange-500 uppercase tracking-widest mb-12 font-black italic uppercase">Lvl {character.coreIdentity?.level} {character.coreIdentity?.species} {character.coreIdentity?.className}</p>
                    <div className="flex flex-col max-w-sm mx-auto gap-4"><button onClick={() => setStep(10)} className="p-6 bg-orange-600 rounded-3xl text-2xl shadow-xl hover:bg-orange-700 transition-all font-black italic uppercase">View Record</button><button onClick={() => setStep(9)} className="p-4 bg-zinc-800 rounded-2xl text-zinc-300 border border-zinc-700 hover:bg-zinc-700 transition-all font-black italic uppercase">Art Weaver</button></div>
                  </div>
                )}
                {step === 9 && (
                    <ScreenWrapper title="Art Weaver" subtitle="Visual direction">
                    {imageChoices.length > 0 && (<div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10 text-white font-black italic uppercase">{imageChoices.map((img, idx) => (<div key={idx} className="relative group"><img src={img} className="w-full rounded-2xl border-2 border-zinc-800 hover:border-orange-500 cursor-pointer aspect-square object-cover shadow-2xl" onClick={() => { setSelectedImage(img); setStep(10); }} alt="" /></div>))}</div>)}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                      <div className="bg-zinc-900 p-6 rounded-3xl border-2 border-zinc-800 space-y-4 text-white text-left font-black italic uppercase">
                        <div className="space-y-1"><label className="text-[10px] text-zinc-500 ml-1 italic uppercase font-black">Style Selection</label><select value={formData.artStyle} onChange={e => updateFormVal('artStyle', e.target.value)} className="w-full bg-zinc-950 border border-zinc-800 p-3 rounded-xl text-sm outline-none focus:border-orange-500 text-white font-black uppercase italic">{ART_STYLES.map(s => <option key={s} value={s}>{s}</option>)}</select></div>
                        <textarea value={formData.artTweaks} onChange={e => updateFormVal('artTweaks', e.target.value)} className="w-full bg-zinc-950 border border-zinc-800 p-3 rounded-xl text-sm h-20 outline-none focus:border-orange-500 text-white font-black not-italic" placeholder="Direct visual tweaks..." />
                        <div className="flex gap-4 font-black italic uppercase text-white"><button onClick={() => setStep(10)} className="flex-1 bg-zinc-800 py-3 rounded-xl hover:bg-zinc-700 transition-all font-black">Back</button><button onClick={generateArt} className="flex-1 bg-orange-600 py-3 rounded-xl text-white hover:bg-orange-700 flex items-center justify-center gap-2 shadow-lg transition-all font-black italic uppercase"><Sparkles size={18}/> Cast Vision</button></div>
                      </div>
                      <div className="bg-zinc-900 p-6 rounded-3xl border-2 border-zinc-800 flex flex-col items-center justify-center gap-4 text-center font-black italic uppercase">
                        <h4 className="text-[10px] text-zinc-500 uppercase font-black italic tracking-widest">Refiner's Eye</h4>
                        {uploadedRef ? (
                           <div className="relative w-full aspect-square group"><img src={uploadedRef} className="w-full h-full object-cover rounded-xl border border-zinc-700 shadow-xl" alt="" /><div className="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-2 rounded-xl"><button onClick={() => { setSelectedImage(uploadedRef); setStep(10); }} className="p-2 bg-orange-600 rounded-lg hover:bg-orange-500 text-[10px] font-black uppercase italic">Use Directly</button><button onClick={() => setUploadedRef(null)} className="p-2 bg-zinc-800 rounded-lg hover:bg-red-600"><Trash2 size={16}/></button></div></div>
                        ) : (
                          <button onClick={() => artUploadRef.current?.click()} className="w-full h-full min-h-[160px] border-2 border-dashed border-zinc-800 rounded-2xl flex flex-col items-center justify-center gap-2 hover:border-orange-500 transition-colors text-zinc-600 hover:text-orange-500"><Upload size={32} /><span>Upload Reference</span></button>
                        )}
                        <input type="file" ref={artUploadRef} onChange={handleArtUpload} className="hidden" accept="image/*" />
                      </div>
                    </div>
                  </ScreenWrapper>
                )}

                {step === 10 && character && (
                  <div className="py-10 animate-in fade-in duration-700 text-zinc-900">
                    <div className="flex flex-wrap justify-center gap-4 mb-12 no-print text-white font-black italic uppercase">
                      <button onClick={exportPDF} className="bg-orange-600 px-8 py-3 rounded-full flex items-center gap-2 shadow-lg hover:bg-orange-700 transition-all text-white"><FileText size={18} /> Export PDF</button>
                      <button onClick={() => setStep(9)} className="bg-orange-950/50 text-orange-400 px-8 py-3 rounded-full flex items-center gap-2 border border-orange-900/50 hover:bg-orange-900/40 transition-all"><Sparkles size={18} /> Art Weaver</button>
                      <button onClick={saveToLibrary} className="bg-zinc-100 text-zinc-950 px-8 py-3 rounded-full flex items-center gap-2 shadow-lg hover:bg-zinc-200 transition-all text-zinc-950"><Save size={18} /> Archive Hero</button>
                      <button onClick={resetForge} className="bg-zinc-900 text-zinc-400 px-8 py-3 rounded-full border border-zinc-800 hover:text-white transition-all font-black">Reset Forge</button>
                    </div>

                    <div ref={recordRef} className="bg-stone-50 text-zinc-900 shadow-2xl rounded-sm font-serif border border-stone-200 overflow-hidden max-w-5xl mx-auto printable-record">
                      {/* PAGE 1 */}
                      <div className="page-section p-8 relative flex flex-col text-zinc-950 font-black italic uppercase">
                        <div className="flex flex-col md:flex-row gap-6 border-b-4 border-zinc-900 pb-4 mb-4">
                          {selectedImage ? <img src={selectedImage} className="w-48 h-48 object-cover border-4 border-zinc-900 shadow-lg grayscale" alt="" /> : <div className="w-48 h-48 bg-stone-200 border-4 border-dashed border-stone-400 flex items-center justify-center text-stone-400 font-black">NO PORTRAIT</div>}
                          <div className="flex-1 space-y-2 overflow-hidden text-zinc-950">
                            <div className="flex items-center gap-3 w-full h-16 relative">
                              {isEditingName ? (<input autoFocus value={character.coreIdentity?.name || ""} onChange={(e) => handleNameChange(e.target.value)} onBlur={() => setIsEditingName(false)} className="text-4xl font-black uppercase tracking-tighter leading-tight w-full bg-stone-200 p-1 border-2 border-orange-500 outline-none text-zinc-950 font-black italic" />) : (<div onClick={() => setIsEditingName(true)} className="flex-1 h-full cursor-pointer hover:bg-stone-200 transition-colors px-1 flex items-center overflow-hidden"><svg viewBox="0 0 400 60" preserveAspectRatio="xMinYMid meet" className="w-full h-full pointer-events-none"><text x="0" y="45" className="uppercase font-black tracking-tighter italic" style={{ fontSize: '48px' }} textLength={character.coreIdentity?.name?.length > 15 ? "100%" : undefined} lengthAdjust="spacingAndGlyphs">{character.coreIdentity?.name || "UNNAMED HERO"}</text></svg></div>)}
                              <button onClick={(e) => { e.stopPropagation(); reRollName(); }} className="p-2 bg-stone-200 hover:bg-orange-500 hover:text-white rounded-lg transition-all text-stone-400 shadow-sm"><Dices size={18} /></button>
                            </div>
                            <div className="flex flex-wrap gap-2 text-[10px] font-black uppercase italic text-orange-800">
                              <span className="bg-stone-200 px-2 py-0.5 border border-stone-300 font-black">Lvl {character.coreIdentity?.level}</span>
                              <span className="bg-stone-200 px-2 py-0.5 border border-stone-300 font-black">{character.coreIdentity?.species}</span>
                              <span className="bg-stone-200 px-2 py-0.5 border border-stone-300 font-black">{character.coreIdentity?.className}</span>
                              <span className="bg-stone-200 px-2 py-0.5 border border-stone-300 font-black">{character.coreIdentity?.background}</span>
                            </div>
                            <div className="grid grid-cols-5 gap-2 bg-white border-2 border-zinc-900 p-2 shadow-sm mt-4 text-center">
                              <div className="border-r border-stone-200"><span className="block text-[6px] text-stone-400 font-black italic uppercase">AC</span><span className="text-xl font-black">{character.vitals?.ac || 10}</span></div>
                              <div className="border-r border-stone-200"><span className="block text-[6px] text-stone-400 font-black italic uppercase">HP</span><span className="text-xl font-black">{character.vitals?.hp || 10}</span></div>
                              <div className="border-r border-stone-200"><span className="block text-[6px] text-stone-400 font-black italic uppercase">Speed</span><span className="text-xl font-black">{character.vitals?.speed || "30ft"}</span></div>
                              <div className="border-r border-stone-200"><span className="block text-[6px] text-stone-400 font-black italic uppercase">Init</span><span className="text-xl font-black">{formatBonus(character.vitals?.initiative || 0)}</span></div>
                              <div className="text-zinc-950 font-black italic uppercase"><span className="block text-[6px] text-stone-400">Prof</span><span className="text-xl text-orange-800">+{getProficiencyBonus(character.coreIdentity?.level || 1)}</span></div>
                            </div>
                          </div>
                        </div>
                        <div className="flex flex-col md:flex-row gap-6 flex-1 text-zinc-950 font-black italic uppercase">
                          <div className="w-full md:w-48 shrink-0 space-y-1.5 font-black italic uppercase text-zinc-950">
                            {STAT_KEYS.map(key => {
                              const val = character.abilityScores?.[key] || 10; const mod = getModifier(val);
                              const isSaveProf = (character.savingThrowProficiencies || []).some(s => s.toLowerCase() === key.toLowerCase());
                              const lvlProf = getProficiencyBonus(character.coreIdentity?.level || 1);
                              return (<div key={key} className="border-2 border-zinc-900 p-1.5 bg-white shadow-sm relative flex flex-col pt-4"><span className="absolute top-0.5 left-1 text-[9px] tracking-wider font-black">{key}</span><div className="flex items-end justify-between mb-1 mt-0.5"><div className="text-2xl tabular-nums leading-none font-black">{val}</div><div className="text-base bg-zinc-900 text-white px-2 py-0.5 rounded text-center leading-none min-w-[2.2rem] font-black">{formatBonus(mod)}</div></div><div className="w-full space-y-0.5 pt-0.5 border-t border-stone-200 font-black"><div className={`flex items-center justify-between text-[8px] ${isSaveProf ? 'text-orange-800' : 'opacity-60'}`}><span className="flex items-center gap-1">{isSaveProf && <Check size={7} strokeWidth={4} />} Save</span><span>{formatBonus(mod + (isSaveProf ? lvlProf : 0))}</span></div>{(ABILITY_SKILLS[key] || []).map(skill => { const isProf = (character.skillProficiencies || []).some(s => s.toLowerCase() === skill.toLowerCase()); return (<div key={skill} className={`flex items-center justify-between text-[8px] ${isProf ? 'text-orange-800' : 'opacity-60'}`}><span className="flex items-center gap-1">{isProf && <Check size={7} strokeWidth={4} />} {skill}</span><span>{formatBonus(mod + (isProf ? lvlProf : 0))}</span></div>); })}</div></div>);
                            })}
                          </div>
                          <div className="flex-1 flex flex-col space-y-4 font-black italic uppercase text-zinc-950 text-left">
                            <section className="flex-1 flex flex-col"><h3 className="text-xl border-b-2 border-zinc-900 mb-1 flex items-center gap-2 italic font-black uppercase"><Sword size={20} /> Combat</h3><table className="w-full text-left text-sm mb-1 font-black italic uppercase text-zinc-950"><thead><tr className="text-[10px] text-stone-400 border-b uppercase font-black italic text-stone-400"><th>Attack</th><th className="text-center font-black italic uppercase text-zinc-950">Bonus</th><th className="text-right font-black italic uppercase text-zinc-400">Damage</th></tr></thead><tbody>{(character.mainAttacks || []).map((a, i) => (<tr key={i} className="border-b border-stone-200 uppercase text-xs italic font-black text-zinc-900"><td className="py-1">{a.name}</td><td className="text-center">{formatBonus(a.bonus)}</td><td className="text-right italic lowercase text-zinc-600 font-serif font-medium">{a.damage} {a.type}</td></tr>))}{Array.from({ length: 4 }).map((_, i) => (<tr key={`empty-${i}`} className="border-b border-stone-100"><td className="py-2.5 h-6"></td><td className="h-6"></td><td className="h-6"></td></tr>))}</tbody></table><div className="flex-1 combat-ruled-lines mt-2 opacity-10" /></section>
                            <section className="mt-auto pt-4 border-t border-dashed border-stone-300 font-black italic uppercase text-zinc-950 text-left"><div className="flex items-center justify-between mb-2 text-zinc-950 font-black uppercase italic"><h3 className="text-xs tracking-widest"><Star size={12} className="text-orange-500" /> Trackers</h3><div className="flex items-center gap-1.5 px-3 py-1 bg-white border border-zinc-900 rounded-sm font-black uppercase text-[8px] text-zinc-900 italic font-black uppercase">Inspiration <div className="w-3.5 h-3.5 border-2 border-zinc-900 rounded-full font-black uppercase italic" /></div></div><div className="grid grid-cols-2 gap-2 text-[9px] font-black uppercase italic text-zinc-700"><div className="bg-stone-100 p-2 border border-stone-300 rounded-sm font-black italic uppercase"><div>Bonus Action <span className="text-[6px] not-italic">Tactical (BA)</span></div><div className="leading-tight text-zinc-950">{(character.vitals?.bonusActions || []).join(", ") || "None"}</div></div><div className="bg-stone-100 p-2 border border-stone-300 rounded-sm font-black italic uppercase text-zinc-950"><div>Reaction <span className="text-[6px] not-italic">Tactical (R)</span></div><div className="leading-tight text-zinc-950">{(character.vitals?.reactions || []).join(", ") || "None"}</div></div></div></section>
                          </div>
                        </div>
                      </div>
                      {/* PAGE 2 ARSENAL */}
                      <div className="page-section page-break p-8 text-zinc-950 font-black italic uppercase text-zinc-950">
                         <div className="flex justify-between items-end border-b-4 border-zinc-900 mb-6 pb-2 text-zinc-900 font-black uppercase italic"><h2 className="text-4xl flex items-center gap-3"><BookOpen size={32} /> Arsenal</h2><p className="text-orange-800 tracking-widest text-xs font-black uppercase italic">Features & Equipment</p></div>
                         <div className="grid grid-cols-2 gap-12 h-[45%] mb-8 border-b-2 border-stone-200 pb-8 text-zinc-950 font-black italic uppercase text-zinc-950 text-left">
                            <section><h3 className="text-[10px] tracking-[0.2em] text-stone-400 mb-2 border-b border-stone-300 pb-1 italic font-black uppercase text-zinc-950">Class & Subclass</h3><div className="space-y-4 overflow-hidden text-zinc-950 font-black italic uppercase">{(character.classFeatures || []).concat(character.subclassFeatures || []).slice(0, 10).map((f, i) => (<div key={i} className="text-[10px] leading-tight mb-2"><strong className="block mb-0.5 font-black uppercase italic text-zinc-950">{f.name} <span className="text-[7px] text-zinc-800 not-italic font-black italic uppercase">[{f.source}]</span></strong><p className="text-zinc-600 font-serif not-italic normal-case lowercase text-[9px] font-medium">{f.summary}</p></div>))}</div></section>
                            <section>
                               <div className="space-y-8">
                                 <div><h3 className="text-[10px] tracking-[0.2em] text-stone-400 mb-2 border-b border-stone-300 pb-1 italic font-black uppercase text-zinc-950">Feats</h3><div className="space-y-3 font-black uppercase italic">{(character.feats || []).map((f, i) => (<div key={i} className="text-[10px] font-black uppercase italic"><strong className="block font-black uppercase italic text-zinc-950">Feat {i+1}: {f.name} <span className="text-[7px] text-zinc-800 not-italic font-black italic uppercase">[{f.source}]</span></strong><p className="text-stone-600 font-serif not-italic normal-case lowercase text-[9px] font-medium">{f.summary}</p></div>))}</div></div>
                                 <div><h3 className="text-[10px] tracking-[0.2em] text-stone-400 mb-2 border-b border-stone-300 pb-1 italic font-black uppercase text-zinc-400">Species Traits</h3><div className="space-y-3 overflow-hidden font-black italic uppercase text-zinc-950">{(character.speciesFeatures || []).map((f, i) => (<div key={i} className="text-[10px] leading-tight"><strong className="block mb-0.5">{f.name} <span className="text-[7px] text-zinc-800 not-italic font-black italic uppercase">[{f.source}]</span></strong><p className="text-stone-600 font-serif not-italic lowercase normal-case text-[9px] font-medium">{f.summary}</p></div>))}</div></div>
                               </div>
                            </section>
                         </div>
                         <div className="grid grid-cols-3 gap-8">
                            <section className="col-span-2 font-black italic uppercase text-zinc-950 text-left"><h3 className="text-[10px] tracking-[0.2em] text-stone-400 mb-2 border-b border-stone-300 pb-1 italic font-black uppercase"><Package size={14} /> Equipment</h3><div className="grid grid-cols-2 gap-x-6 gap-y-2 text-zinc-950 font-black italic uppercase">{(character.equipment || []).map((item, i) => { const itName = typeof item === 'string' ? item : item.name; const itSum = typeof item === 'string' ? '' : item.summary; const itSrc = typeof item === 'string' ? '' : item.source; return (<div key={i} className="text-[10px] border-b border-stone-100 py-1 leading-tight"><strong className="block font-black uppercase italic">{itName} {itSrc && <span className="text-[7px] text-zinc-800 not-italic font-black italic uppercase">[{itSrc}]</span>}</strong>{itSum && <p className="text-stone-500 font-serif not-italic line-clamp-1 lowercase text-[8px] font-medium">{itSum}</p>}</div>); })}{Array.from({ length: Math.max(0, 10 - (character.equipment?.length || 0)) }).map((_, i) => (<div key={i} className="text-[10px] border-b border-stone-100 h-8" />))}</div></section>
                            <section className="space-y-6 font-black italic uppercase text-zinc-950 text-left"><div><h3 className="text-[10px] tracking-[0.2em] text-stone-400 mb-2 border-b border-stone-300 pb-1 italic font-black uppercase">Attunement</h3><div className="space-y-1 text-zinc-950 font-black italic uppercase">{(character.attunedItems || []).map((item, i) => (<div key={i} className="h-auto border-b border-stone-200 text-[9px] px-1 py-1 italic">{typeof item === 'string' ? item : item.name}</div>))}{Array.from({ length: Math.max(0, 3 - (character.attunedItems?.length || 0)) }).map((_, i) => (<div key={i} className="h-6 border-b border-stone-200 text-[9px] italic text-stone-300 flex items-center px-1 not-italic opacity-40">Available</div>))}</div></div><div><h3 className="text-[10px] tracking-[0.2em] text-stone-400 mb-2 border-b border-stone-300 pb-1 italic font-black uppercase"><Coins size={14} /> Currency</h3><div className="flex justify-between border-b border-stone-200 px-1 text-xs pt-2 font-black italic uppercase tracking-tighter"><span>Wealth</span><span>{character.currency?.gp || 0} GP</span></div></div></section>
                         </div>
                      </div>
                      {/* PAGE 3 STORY */}
                      <div className="page-section page-break p-8 text-zinc-900 font-black italic uppercase text-zinc-900">
                         <div className="flex justify-between items-end border-b-4 border-zinc-900 mb-4 pb-2 text-zinc-900 font-black uppercase italic"><h2 className="text-4xl flex items-center gap-3 font-black italic uppercase"><User size={32} /> Description</h2><p className="text-orange-800 text-xs font-black uppercase italic">{character.coreIdentity?.name || "Unnamed"}</p></div>
                         <div className="grid grid-cols-1 md:grid-cols-3 gap-8 font-black italic uppercase text-zinc-900 text-left">
                            <div className="md:col-span-2 space-y-6 text-lg font-black italic uppercase text-zinc-900"><section><div className="flex items-center justify-between border-b-2 border-zinc-900 mb-3 uppercase italic font-black text-zinc-900 italic uppercase"><h3 className="text-2xl font-black italic uppercase text-zinc-900">Heroic Origins</h3><div className="flex gap-2"><button onClick={reRollStory} className="p-1 text-zinc-400 hover:text-orange-500 transition-colors no-print font-black italic uppercase"><RefreshCw size={18} /></button></div></div><p className="leading-relaxed whitespace-pre-wrap text-zinc-950 normal-case italic font-serif font-medium">{character.backgroundStory}</p></section></div>
                            <div className="space-y-6 font-black italic uppercase text-zinc-900"><section className="bg-stone-100 p-4 border-2 border-stone-200 text-zinc-900 font-black italic uppercase text-zinc-900"><div className="flex items-center justify-between border-b border-stone-300 pb-1 mb-2 italic text-zinc-900 font-black italic uppercase"><h3 className="text-xs font-black italic uppercase text-zinc-900">Appearance</h3><button onClick={reRollAppearance} className="p-1 text-zinc-300 hover:text-orange-500 transition-colors no-print font-black italic uppercase"><RefreshCw size={14} /></button></div><p className="text-sm leading-relaxed whitespace-pre-wrap font-serif font-medium not-italic normal-case lowercase text-zinc-900">{character.description}</p></section></div>
                         </div>
                      </div>
                      {/* PAGE 4 SPELLS */}
                      {character.spellcasting && character.spellcasting.isCaster && (
                        <div className="page-section page-break p-8 text-zinc-900 font-black italic uppercase text-zinc-950">
                          <div className="flex justify-between items-end border-b-4 border-zinc-900 mb-2 pb-2 text-zinc-900 font-black uppercase italic text-zinc-950"><h2 className="text-4xl flex items-center gap-3 font-black uppercase italic text-zinc-950"><Zap size={32} /> Spellcasting</h2><div className="flex gap-4 text-orange-800 text-xs font-black italic uppercase tracking-tighter"><span>DC: {character.spellcasting.spellDC}</span><span>Atk: {formatBonus(character.spellcasting.spellAttack)}</span></div></div>
                          <div className="flex flex-wrap gap-4 mb-8 p-3 bg-stone-100 border border-stone-200 rounded-sm text-zinc-900 font-black italic uppercase text-zinc-950">
                             {Object.entries(character.spellcasting.slots || {}).sort(([a], [b]) => parseInt(a) - parseInt(b)).map(([lvl, count]) => (<div key={lvl} className="flex flex-col items-center border-r border-stone-300 pr-4 last:border-0 font-black uppercase italic"><span className="text-[7px] text-stone-400 mb-1 leading-none uppercase font-black italic">Lv{lvl}</span><div className="flex gap-1">{Array.from({ length: count }).map((_, i) => (<div key={i} className="w-2.5 h-2.5 border border-zinc-950 rounded-sm bg-white shadow-sm font-black italic uppercase" />))}</div></div>))}
                          </div>
                          <div className="spell-grid-container text-zinc-900 font-black italic uppercase text-zinc-950 text-left">
                            {Object.entries(character.spellcasting?.spellsByLevel || character.spellcasting?.spells || {}).sort(([a], [b]) => parseInt(a) - parseInt(b)).map(([lvl, spells]) => {
                              if (!spells || spells.length === 0) return null;
                              return (
                                <div key={lvl} className="break-inside-avoid mb-6 border-b border-stone-100 pb-4 font-black italic uppercase text-left">
                                  <h4 className="text-sm text-zinc-500 border-b border-stone-300 pb-1 mb-2 italic uppercase font-black tracking-widest">Level {lvl} Spells</h4>
                                  <div className="space-y-3">
                                    {(spells || []).map((s, i) => (
                                      <div key={i} className="text-[14px] leading-tight font-black uppercase italic">
                                        <strong className="text-zinc-950 font-black italic uppercase">{s.name}:</strong> <span className="text-zinc-600 font-serif not-italic normal-case font-medium">{s.summary}</span> <span className="text-[7px] text-zinc-400 not-italic normal-case font-black italic uppercase text-zinc-400">[{s.source}]</span>
                                      </div>
                                    ))}
                                  </div>
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                )}
              </div>
            )}
          </>
        )}
      </main>

      <style>{`
        @media print { .no-print { display: none !important; } }
        .page-break { page-break-before: always; }
        .printable-record { background-image: radial-gradient(#e5e7eb 1px, transparent 1px); background-size: 20px 20px; }
        .spell-grid-container { columns: 2; column-gap: 3rem; column-fill: auto; height: auto; min-height: 800px; }
        .break-inside-avoid { break-inside: avoid; page-break-inside: avoid; }
        .page-section { min-height: 290mm; }
        .combat-ruled-lines { background-image: linear-gradient(#e5e7eb 1px, transparent 1px); background-size: 100% 24px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 24px; height: 24px; background: #f97316; border-radius: 50%; cursor: pointer; border: 4px solid #18181b; }
      `}</style>
    </div>
  );
};

export default App;
